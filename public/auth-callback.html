<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Accesso in corso... - Project Gauss</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="auth-container">
    <div class="auth-card" style="text-align: center;">
      <img src="/img/gauss-logo.png" alt="Project Gauss" class="auth-logo" style="filter: brightness(0) saturate(100%) invert(15%) sepia(90%) saturate(6000%) hue-rotate(200deg) brightness(100%) contrast(100%);">
      <h1>Project Gauss</h1>

      <!-- Loading state -->
      <div id="callback-loading">
        <div class="spinner" style="margin: 32px auto;"></div>
        <p class="subtitle" id="callback-status">Verifica in corso...</p>
      </div>

      <!-- Error state -->
      <div id="callback-error" class="hidden">
        <div style="font-size: 3rem; margin: 16px 0;">üòï</div>
        <p class="subtitle" id="error-message">Si √® verificato un errore.</p>
        <a href="/" class="btn btn-primary" style="margin-top: 16px;">Torna al login</a>
      </div>

      <!-- Success state (email verified) -->
      <div id="callback-success" class="hidden">
        <div style="font-size: 3rem; margin: 16px 0;">‚úÖ</div>
        <p class="subtitle">Email verificata con successo!</p>
        <p class="subtitle" style="margin-bottom: 0;">Reindirizzamento...</p>
      </div>

      <!-- Needs school selection -->
      <div id="callback-school" class="hidden">
        <div style="font-size: 3rem; margin: 16px 0;">üè´</div>
        <p class="subtitle">Benvenuto! Seleziona la tua scuola per completare la registrazione.</p>
        <form id="school-form" style="margin-top: 16px;">
          <div class="form-group">
            <select id="school-select" required>
              <option value="">Seleziona la tua scuola...</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary">Conferma</button>
        </form>
      </div>

      <div class="auth-footer">
        Sviluppato e manutenuto da <a href="#">Cristian Ceni</a>
      </div>
    </div>
  </div>

  <script src="/js/api.js"></script>
  <script>
    (async function () {
      const loadingEl = document.getElementById("callback-loading");
      const errorEl = document.getElementById("callback-error");
      const successEl = document.getElementById("callback-success");
      const schoolEl = document.getElementById("callback-school");
      const statusEl = document.getElementById("callback-status");
      const errorMsgEl = document.getElementById("error-message");

      try {
        // Supabase OAuth mette i token nel fragment (#)
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);

        const accessToken = params.get("access_token");
        const refreshToken = params.get("refresh_token");
        const errorParam = params.get("error_description");
        const type = params.get("type"); // "signup" per email confirmation

        // Anche query string per email verification
        const queryParams = new URLSearchParams(window.location.search);
        const errorQuery = queryParams.get("error_description");

        if (errorParam || errorQuery) {
          throw new Error(errorParam || errorQuery);
        }

        if (!accessToken) {
          // Potrebbe essere un redirect di conferma email via PKCE
          // In quel caso Supabase potrebbe usare query params
          const code = queryParams.get("code");
          if (code) {
            // Verifica email confirmation code
            statusEl.textContent = "Verifica email in corso...";
            // Per PKCE flow, l'exchange avviene lato client con supabase-js
            // Ma noi non lo usiamo direttamente, redirect a login
            loadingEl.classList.add("hidden");
            successEl.classList.remove("hidden");
            setTimeout(() => {
              window.location.href = "/?verified=1";
            }, 1500);
            return;
          }

          throw new Error("Token di accesso mancante. Riprova il login.");
        }

        // Salva i token
        localStorage.setItem("access_token", accessToken);
        if (refreshToken) {
          localStorage.setItem("refresh_token", refreshToken);
        }

        statusEl.textContent = "Verifica account...";

        // Verifica il profilo lato server 
        const result = await API.request("auth-verify", {
          method: "POST",
          body: JSON.stringify({ access_token: accessToken, refresh_token: refreshToken }),
        });

        if (result.needsSchool) {
          // Mostra selezione scuola
          loadingEl.classList.add("hidden");
          schoolEl.classList.remove("hidden");

          // Carica scuole
          const { schools } = await API.getSchools();
          const select = document.getElementById("school-select");
          schools.forEach((s) => {
            const opt = document.createElement("option");
            opt.value = s.id;
            opt.textContent = `${s.name} - ${s.city}`;
            select.appendChild(opt);
          });

          document.getElementById("school-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const schoolId = document.getElementById("school-select").value;
            if (!schoolId) return;

            const btn = e.target.querySelector("button");
            btn.disabled = true;
            btn.textContent = "Salvataggio...";

            try {
              await API.updateProfile({ school_id: schoolId });
              window.location.href = "/dashboard.html";
            } catch (err) {
              errorMsgEl.textContent = err.message;
              schoolEl.classList.add("hidden");
              errorEl.classList.remove("hidden");
            }
          });
          return;
        }

        // Tutto ok, redirect alla dashboard
        loadingEl.classList.add("hidden");
        successEl.classList.remove("hidden");

        setTimeout(() => {
          window.location.href = "/dashboard.html";
        }, 1000);

      } catch (err) {
        console.error("Callback error:", err);
        loadingEl.classList.add("hidden");
        errorMsgEl.textContent = err.message || "Si √® verificato un errore durante l'accesso.";
        errorEl.classList.remove("hidden");

        // Pulisci token se c'√® un errore
        localStorage.removeItem("access_token");
        localStorage.removeItem("refresh_token");
      }
    })();
  </script>
</body>
</html>
